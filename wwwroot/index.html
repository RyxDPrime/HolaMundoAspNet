<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto Alonso Test</title>
    <style>
        :root { 
            --primary: #0078d4; 
            --danger: #d13438; 
            --success: #107c10; 
            --bg: #f3f2f1; 
            --white: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 20px; 
            color: #323130;
        }

        .container { max-width: 900px; margin: auto; }
        
        /* Tarjetas Estilo Fluent */
        .card { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }

        h1, h2 { color: var(--primary); margin-top: 0; }

        /* Controles y Formulario */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            min-width: 200px; 
            outline-color: var(--primary);
        }
        
        /* Botones */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            text-decoration: none; 
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-danger { background: var(--danger); color: white; padding: 6px 12px; font-size: 13px; }
        .btn-edit { background: var(--primary); color: white; padding: 6px 12px; font-size: 13px; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }

        /* Tabla de Datos */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #faf9f8; color: #666; font-size: 14px; text-transform: uppercase; }
        .badge { background: #e1dfdd; padding: 4px 8px; border-radius: 4px; font-family: monospace; }

        /* --- MODAL FLOTANTE --- */
        .modal-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 320px;
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>Hola Mundo</h1>
        <p>Prueba del framework ASP.NET con SQLite, VS Code y Dotnet 10.0 (LTS)</p>
        
        <div class="controls">
            <a href="/swagger" target="_blank" class="btn btn-outline">Swagger UI</a>
            <button onclick="probarHola()" class="btn btn-main">Saludo</button>
        </div>
    </div>

    <div class="card">
        <h2>Registro de Visitas</h2>
        
        <div class="controls">
            <input type="text" id="nombreInput" placeholder="Nombre completo del visitante...">
            <button id="registrarBtn" onclick="guardarVisita()" class="btn btn-main">Registrar</button>
        </div>

        <div class="controls">
            <input type="text" id="buscarInput" placeholder="Buscar por nombre en la base de datos..." onkeyup="buscarVisita()">
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Fecha de Registro</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="tablaCuerpo">
                </tbody>
        </table>
    </div>
</div>

<div id="miModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitulo" style="margin-bottom: 10px;"></h2>
        <p id="modalMensaje" style="font-size: 1.2rem; margin-bottom: 5px;"></p>
        <p id="modalFecha" style="font-size: 0.85rem; color: #666; margin-bottom: 20px;"></p>
        <button onclick="cerrarModal()" class="btn btn-main" style="width: 100%;">Cerrar Ventana</button>
    </div>
</div>

<div id="nombreModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="margin-bottom: 10px;">Saludo Personalizado</h2>
        <p style="font-size: 1.0rem; margin-bottom: 15px;">Escribe tu nombre</p>
        <input type="text" id="nombreSaludoInput" placeholder="Tu nombre..." style="width: 100%; margin-bottom: 15px;">
        <div style="display: flex; gap: 10px;">
            <button onclick="confirmarNombre()" class="btn btn-main" style="flex: 1;">Enviar</button>
            <button onclick="cerrarNombreModal()" class="btn btn-outline" style="flex: 1;">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // Inicialización
    document.addEventListener('DOMContentLoaded', cargarTodas);

    let editingId = null;

    async function cargarTodas() {
        const res = await fetch('/visitas');
        const datos = await res.json();
        renderizarTabla(datos);
    }

    function renderizarTabla(datos) {
        const cuerpo = document.getElementById('tablaCuerpo');
        if(datos.length === 0) {
            cuerpo.innerHTML = `<tr><td colspan="4" style="text-align:center">No hay registros encontrados</td></tr>`;
            return;
        }
        cuerpo.innerHTML = datos.map(v => {
            const enEdicion = editingId === v.id;
            const botonEliminar = enEdicion
                ? `<button onclick="cancelarEdicion()" class="btn btn-danger">Cancelar</button>`
                : `<button onclick="eliminarVisita(${v.id})" class="btn btn-danger">Eliminar</button>`;
            const botonEditar = enEdicion
                ? `<button onclick="aceptarEdicion(${v.id})" class="btn btn-edit">Aceptar</button>`
                : `<button onclick="iniciarEdicion(${v.id})" class="btn btn-edit">Editar</button>`;
            return `
            <tr>
                <td><span class="badge">#${v.id}</span></td>
                <td>
                    ${enEdicion
                        ? `<input type="text" id="editNombre-${v.id}" value="${v.nombre.replace(/"/g, '&quot;')}" style="width: 100%;">`
                        : `<strong>${v.nombre}</strong>`}
                </td>
                <td>${new Date(v.fechaRegistro).toLocaleString()}</td>
                <td>
                    ${botonEditar}
                    ${botonEliminar}
                </td>
            </tr>
            `;
        }).join('');
    }

    function iniciarEdicion(id) {
        editingId = id;
        cargarTodas();
    }

    function cancelarEdicion() {
        editingId = null;
        const input = document.getElementById('nombreInput');
        input.value = '';
        cargarTodas();
    }

    async function aceptarEdicion(id) {
        const input = document.getElementById(`editNombre-${id}`);
        const nombre = (input?.value || '').trim();
        if (!nombre) return alert("Por favor, ingresa un nombre válido.");

        const res = await fetch(`/visitas/${id}?nombre=${encodeURIComponent(nombre)}`, { method: 'PUT' });

        if (res.ok) {
            editingId = null;
            cargarTodas();
        }
    }

    async function guardarVisita() {
        const input = document.getElementById('nombreInput');
        const nombre = input.value.trim();
        if (!nombre) return alert("Por favor, ingresa un nombre válido.");

        const res = await fetch(`/visitas?nombre=${encodeURIComponent(nombre)}`, { method: 'POST' });
        if (res.ok) {
            input.value = '';
            cargarTodas();
        }
    }

    async function eliminarVisita(id) {
        if (!confirm("¿Estás seguro de que deseas eliminar este registro?")) return;
        const res = await fetch(`/visitas/${id}`, { method: 'DELETE' });
        if (res.ok) cargarTodas();
    }

    async function buscarVisita() {
        const termino = document.getElementById('buscarInput').value;
        if (termino.trim().length === 0) return cargarTodas();

        const res = await fetch(`/visitas/buscar?termino=${encodeURIComponent(termino)}`);
        const resultados = await res.json();
        renderizarTabla(resultados);
    }

    // Lógica del Modal Flotante
    async function probarHola() {
        abrirNombreModal();
    }

    function abrirNombreModal() {
        const input = document.getElementById('nombreSaludoInput');
        input.value = '';
        document.getElementById('nombreModal').style.display = 'flex';
        setTimeout(() => input.focus(), 0);
    }

    function cerrarNombreModal() {
        document.getElementById('nombreModal').style.display = 'none';
    }

    async function confirmarNombre() {
        const input = document.getElementById('nombreSaludoInput');
        const nombre = input.value.trim();
        if (!nombre) return;

        cerrarNombreModal();

        try {
            const res = await fetch(`/hola?nombre=${encodeURIComponent(nombre)}`);
            const data = await res.json();

            document.getElementById('modalTitulo').innerText = "Respuesta de la API";
            document.getElementById('modalMensaje').innerText = data.mensaje;
            document.getElementById('modalFecha').innerText = "Servidor: " + data.fecha;
            
            document.getElementById('miModal').style.display = 'flex';
        } catch (e) {
            alert("Error al conectar con el servidor.");
        }
    }

    function cerrarModal() {
        document.getElementById('miModal').style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(e) {
        if (e.target.id === 'miModal') cerrarModal();
        if (e.target.id === 'nombreModal') cerrarNombreModal();
    }
</script>

</body>
</html>